---
section: os_guide
title: "Практическая работа - создание и запуск собственного сервиса"
---


#### Цель работы

Познакомиться с механизмом управления службами и автозапуском в Linux, создать и запустить собственноручно написанную программу как сервис операционной системы.


#### Основное задание



1. Создайте скрипт на языке Python, который выполняет какую-нибудь операцию в фоне.
2. Зарегистрируйте этот скрипт как системную службу (демона), которая стартует при запуске системы с помощью инициализатора _systemd_.


#### Методические указания

На большинстве современных дистрибутивов Linux за автозапуск системных служб отвечает специальная программа _systemd_. Она постепенно заменяет более старую систему инициализации операционной системы init. В настоящее время init считается устаревшей системой и постепенно ожидается, что все основные дистрибутивы перейдут на _systemd_. Эта система инициализации предоставляет больше возможностей и гибче в настройке. 


##### Создание программы

Для начала создадим простой скрипт. Он использует сокеты для создания простейшего эхо сервера на порту 9988. Вы можете модифицировать этот скрипт на свое усмотрение.

```py
#!/usr/bin/python3
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind(("localhost", 9988))
s.listen(1)
while True:
	conn, addr = s.accept()
	data = conn.recv(1024)
	conn.send(data)
	conn.close()
```

Для того, чтобы система могла запустить нашу программу при старте нужно указать команду запуска, включающую полный путь к файлу. Вы можете скопировать его в одну из системных папок (например, _/usr/bin/_) или вызывать его из домашней директории. В любом случае, нужно запомнить команду запуска нашей программы. 

Обратите внимание на шебанг в начале скрипта. Он позволяет запускать его непосредственно командой _./server.py_, без указания пути к интерпретатору. В принципе, вы можете обойтись без шебанга и включить в команду запуска и путь к интерпретатору Python.


##### Настройка автозапуска

Чтобы создать сервис, вы должны создать соответствующий конфигурационный файл. Он содержит все необходимые настройки для запуска сервиса в виде текста в определенном формате. Он должен называться _\<servicename\>.service_, где _\<servicename\>_ - это системное имя вашего демона. Этот файл должен располагаться в одном из определенных директорий, которые сканируются программой _systemd_. Полный список таких директорий вы можете найти в [документации](https://www.freedesktop.org/software/systemd/man/systemd.unit.html#User%20Unit%20Search%20Path). Некоторые из них являются системными и для доступа к ним нужны права суперпользователя. Некоторые - специфичны для текущего пользователя. В данном примере мы будем использовать папку _/etc/systemd/system/_.

Давайте создадим текстовый файл _/etc/systemd/system/dummy.service_. В него запишем такие директивы:

```
[Unit]
Description=Dummy Service

[Service]
Type=simple
ExecStart=/home/user/dummy.py
```

Файл юнитов организован, как и многие конфигурационные файлы Linux  в виде разделов. Главный раздел называется Unit. Подробное описание всех разделов и директив можете почитать, например, [здесь](https://linux-notes.org/pishem-systemd-unit-fajl/). После этого вы можете управлять этим сервером используя команды _systemctl_.


##### Команды управления демоном

Теперь вы можете использовать команду _systemctl_, чтобы управлять своим сервисом. Для начала введите 

```bash
systemctl status dummy
```

Эта команда покажет информацию о вашем сервисе. Главное, что здесь можно узнать, это то, запущен ли он в данный момент. Запустить сервис можно командой _systemctl start dummy_:


![Запущенный сервис](/assets/images/os_text/os21-1.png "Запущенный сервис"){: .align-center style="width: 50%;"}

Кроме этих двух могут быть полезными еще другие команды из семейства systemctl:

- enable - включение автозапуска сервиса при старте системы;
- disable - отключение автозапуска;
- restart - перезапуск сервиса: сервис будет остановлен и заново запущен;
- stop - остановка сервиса;
- reload - обновление конфигурации сервиса без перезапуска.


##### Дополнительные настройки

При помощи директив в файле юнита можно довольно гибко настроить поведение сервиса при запуске. Например, можно указать, что данный сервис должен запускаться только после указанных. Это может быть полезно, если ваш демон зависит от каких-то других. Например, если при старте ваша программа подключается к базе данных, она должна быть запущена только после демона СУБД. Для этого используются директивы _After, Requires, Wants_.

Можно настроить запуск сервиса с привилегиями определенного пользователя при помощи директив _User_ и _Group_ и задать рабочий каталог для программы сервиса (_WorkingDirectory_).

При помощи директивы Restart можно настроить перезапуск процесса при его завершении. Здесь же можно указать, в каких случаях нужно заново запускать программу,  также настроить интервал ожидания.

#### Задания для самостоятельного выполнения

1. Настройте автозапуск вашего демона таким образом, чтобы он автоматически перезапускался через 2 секунды после завершения процесса вследствие, например, программной ошибки.
2. Создайте скрипт установки вашей программы, который автоматически копирует ее в системный каталог и настраивает автовыполнение как службы Linux.
3. (\*) Создайте скрипт установки, который автоматически распознает программу управления службами (_systemd, init, upstart_) и регистрирует программу соответственно.

#### Контрольные вопросы

1. Чем процесс-демон отличается от обычного процесса?
2. Какие основные программы управляют автозапуском систем Linux?
3. Какие действия можно проделать с помощью команды _systemctl_?
4. Чем отличается включение и запуск службы?
5. Как зарегистрировать программу как службу операционной системы?